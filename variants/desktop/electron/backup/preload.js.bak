// variants/desktop/electron/src/preload.js
const { contextBridge, ipcRenderer } = require('electron');

// ================================
// EXPOSITION DES APIs ELECTRON
// ================================
contextBridge.exposeInMainWorld('electronAPI', {
  // RÃ©cupÃ©rer l'URL de base de l'API Laravel
  getApiBase: () => ipcRenderer.invoke('get-api-base'),
  
  // RÃ©cupÃ©rer les informations de l'application
  getAppInfo: () => ipcRenderer.invoke('get-app-info'),
  
  // VÃ©rifier si on est dans Electron
  isElectron: () => true,
  
  // Plateforme
  platform: process.platform,
  
  // ================================
  // NOUVELLES FONCTIONNALITÃ‰S POUR AUTH OFFLINE
  // ================================
  
  // Gestion du stockage local sÃ©curisÃ© (pour tokens, sessions, etc.)
  storage: {
    get: (key) => ipcRenderer.invoke('storage-get', key),
    set: (key, value) => ipcRenderer.invoke('storage-set', key, value),
    delete: (key) => ipcRenderer.invoke('storage-delete', key),
    clear: () => ipcRenderer.invoke('storage-clear')
  },
  
  // Gestion des fichiers (pour base de donnÃ©es SQLite locale)
  fs: {
    readFile: (path) => ipcRenderer.invoke('fs-read-file', path),
    writeFile: (path, data) => ipcRenderer.invoke('fs-write-file', path, data),
    exists: (path) => ipcRenderer.invoke('fs-exists', path),
    deleteFile: (path) => ipcRenderer.invoke('fs-delete-file', path)
  },
  
  // Gestion de l'impression (pour factures)
  print: {
    invoice: (html) => ipcRenderer.invoke('print-invoice', html),
    receipt: (html) => ipcRenderer.invoke('print-receipt', html)
  },
  
  // Ã‰vÃ©nements systÃ¨me
  on: (channel, callback) => {
    const validChannels = ['app-ready', 'auth-changed', 'network-status'];
    if (validChannels.includes(channel)) {
      const subscription = (event, ...args) => callback(...args);
      ipcRenderer.on(channel, subscription);
      return () => ipcRenderer.removeListener(channel, subscription);
    }
  }
});

// ================================
// PROTECTION CONTRE LES ERREURS GLOBALES
// ================================
window.addEventListener('error', (event) => {
  // Intercepter l'erreur dragEvent spÃ©cifique
  if (event.message && event.message.includes('dragEvent')) {
    console.warn('âš ï¸ Erreur dragEvent interceptÃ©e et ignorÃ©e');
    event.preventDefault();
    return true;
  }
  
  // Logger les autres erreurs pour debug
  console.error('âŒ Erreur globale:', {
    message: event.message,
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno
  });
});

// Protection contre les promesses rejetÃ©es non gÃ©rÃ©es
window.addEventListener('unhandledrejection', (event) => {
  console.error('âŒ Promise rejetÃ©e non gÃ©rÃ©e:', event.reason);
});

// ================================
// LOGGING DE DÃ‰MARRAGE
// ================================
console.log('âœ… Preload script chargÃ© avec succÃ¨s');
console.log('ğŸ“¦ Electron API exposÃ©e avec:', Object.keys(window.electronAPI || {}));
console.log('ğŸ–¥ï¸  Platform:', process.platform);
console.log('ğŸ”§ Node version:', process.versions.node);
console.log('âš¡ Electron version:', process.versions.electron);
console.log('ğŸ¯ Chrome version:', process.versions.chrome);